<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @page { margin: 20mm }
    
    body { 
      font-family: 'Helvetica', Arial, sans-serif; 
      color: #1f2d3d; 
      font-size: 12px;
      line-height: 1.6;
    }
    
    .top { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start;
      margin-bottom: 40px;
      border-bottom: 3px solid #0b4a8b;
      padding-bottom: 20px;
    }
    
    .brand { 
      display: block;
      width: 100%;
    }
    
    .brand h1 { 
      font-size: 48px; 
      color: #0b4a8b; 
      margin: 0 0 20px 0; 
      letter-spacing: 2px;
      text-align: center;
      border-bottom: 2px solid #0b4a8b;
      padding-bottom: 10px;
    }
    
    .company-info { 
      font-size: 12px; 
      color: #333; 
      margin-top: 6px;
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 8px;
    }
    
    .company-name {
      font-size: 18px;
      font-weight: 800;
      color: #0b4a8b;
      margin-bottom: 15px;
      text-align: center;
      text-transform: uppercase;
    }
    
    .company-info .details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .detail-row {
      padding: 4px 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    .legal-details {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 2px solid #0b4a8b;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: #666;
    }

    .meta-row { display: flex; justify-content: space-between; margin-top: 24px; }
    .bill-to { width: 55%; }
    .devis-info { width: 40%; text-align: right; }
    .section-title { color: #0b4a8b; font-weight: 700; margin-bottom: 8px; }

    table.items { width: 100%; border-collapse: collapse; margin-top: 18px; }
    table.items thead th { border-bottom: 2px solid #cfcfcf; padding: 10px 8px; text-align: left; color: #0b4a8b; font-weight: 700; }
    table.items tbody td { padding: 10px 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .qty { width: 80px; text-align: left; }
  .desc { word-break: break-word; }
    .unit { width: 120px; text-align: right; }
    .amount { width: 140px; text-align: right; }

    .totals { 
      margin-top: 30px; 
      width: 40%; 
      float: right;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-right: 4px solid #0b4a8b;
    }
    
    .totals table { 
      width: 100%;
      border-collapse: collapse;
    }
    
    .totals td { 
      padding: 8px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .totals tr:last-child td {
      border-bottom: none;
    }
    
    .totals .label { 
      text-align: left;
      color: #495057;
      font-weight: 600;
    }
    
    .totals .value { 
      text-align: right;
      font-family: 'Courier New', monospace;
    }
    
    .grand-total { 
      font-size: 20px; 
      font-weight: 800; 
      color: #0b4a8b;
      background: #e7f0ff;
      border-radius: 4px;
    }

    .footer { 
      clear: both; 
      margin-top: 80px; 
      border-top: 2px solid #0b4a8b; 
      padding-top: 20px; 
      display: flex; 
      justify-content: space-between;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
    }
    
    .conditions { 
      width: 60%; 
      font-size: 11px;
      color: #666;
      line-height: 1.4;
    }
    
    .legal-info {
      margin-top: 10px;
      font-size: 10px;
      color: #888;
    }
    
    .merci { 
      width: 30%; 
      text-align: center; 
      color: #0b4a8b; 
      font-family: 'Brush Script MT', cursive; 
      font-size: 36px;
      position: relative;
    }
    
    .merci::after {
      content: '';
      display: block;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, #0b4a8b, transparent);
      margin-top: 10px;
    }

    /* small print */
    .small { font-size: 10px; color: #666; }
  </style>
</head>
<body>

  <div class="top">
    <div class="brand">
      <h1>DEVIS</h1>
      <div class="company-info">
        <div class="company-name"><%= companyName || 'Bedouielec Transformateurs' %></div>
        <div class="details">
          <% if (companyAddress) { %>
            <div class="detail-row"><%= companyAddress %></div>
          <% } %>
          <% if (companyPhone) { %>
            <div class="detail-row">Tél: <%= companyPhone %></div>
          <% } %>
          <% if (companyEmail) { %>
            <div class="detail-row">Email: <%= companyEmail %></div>
          <% } %>
          <% if (companySite) { %>
            <div class="detail-row">Site web: <%= companySite %></div>
          <% } %>
          <div class="legal-details">
            <% if (companySiret) { %>
              <div>SIRET: <%= companySiret %></div>
            <% } %>
            <% if (companyApe) { %>
              <div>Code APE: <%= companyApe %></div>
            <% } %>
            <% if (companyTva) { %>
              <div>N° TVA: <%= companyTva %></div>
            <% } %>
          </div>
        </div>
      </div>
      </div>
    </div>
    <div class="logo">
      <% if (typeof logoUrl !== 'undefined' && logoUrl) { %>
        <img src="<%= logoUrl %>" alt="logo" style="max-width:160px;" />
      <% } else { %>
        <!-- optional logo placeholder -->
      <% } %>
    </div>
  </div>

  <div class="meta-row">
  <div class="bill-to">
      <div class="section-title">FACTURÉ À</div>
      <div><strong>Adresse du client :</strong></div>
      <div><%= (typeof company === 'undefined' || !company ? name : company) %></div>
      <div>Téléphone : <%= phone %></div>
      <div>Email : <%= email %></div>
    </div>

    <div class="devis-info">
      <!-- DEVIS number removed as requested -->
      <div style="font-weight:700; color:#0b4a8b;">DATE DU DEVIS</div>
      <div><%= new Date().toLocaleDateString('fr-FR') %></div>
    </div>
  </div>

  <table class="items">
    <thead>
      <tr>
        <th class="qty">QTÉ</th>
        <th class="desc">DÉSIGNATION</th>
        <th class="unit">PRIX UNIT. HT</th>
        <th class="amount">MONTANT HT</th>
      </tr>
    </thead>
    <tbody>
      <% products.forEach(function(item){ %>
        <tr>
          <td class="qty"><%= item.quantity %></td>
          <td class="desc"><%= item.product.name %></td>
          <td class="unit"><%= Number(item.product.price).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
          <td class="amount"><%= Number(item.totalPrice).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <% 
    // compute totals: assume totalPrice is HT
    const totalHT = Number(totalPrice || 0);
    const tvRate = (typeof tvaRate !== 'undefined' && tvaRate !== null) ? Number(tvaRate) : 0.20; // default 20%
    const tvaAmount = Math.round((totalHT * tvRate) * 100) / 100;
    const totalTTC = Math.round((totalHT + tvaAmount) * 100) / 100;
  %>

  <div class="totals">
    <table>
      <tr>
  <td class="label small">Total HT</td>
  <td class="value small"><%= totalHT.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %> TND</td>
      </tr>
      <tr>
  <td class="label small">TVA <%= (tvaRate*100).toFixed(0) %>%</td>
  <td class="value small"><%= tvaAmount.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %> TND</td>
      </tr>
      <tr>
  <td class="label grand-total">TOTAL</td>
  <td class="value grand-total"><%= totalTTC.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %> TND</td>
      </tr>
    </table>
  </div>

  <div class="footer">
    <div class="conditions">
      <div style="color:#c0392b; font-weight:700; margin-bottom:6px;">CONDITIONS ET MODALITÉS DE PAIEMENT</div>
      <div class="small">Si ce devis vous convient, veuillez le retourner précédé de la mention : "BON POUR ACCORD ET EXÉCUTION DU DEVIS"</div>
      <div class="small" style="margin-top:8px">Date : ____________</div>
      <div class="small">Signature : ____________________________</div>
    </div>
    <div class="merci">
      Merci
    </div>
  </div>

</body>
</html>
